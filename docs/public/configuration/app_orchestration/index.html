<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.17" />
    <meta name="description" content="Documentation for the Choria Orchestrator">
<meta name="author" content="R.I.Pienaar &lt;rip@devco.net&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    
    <title>Application Orchestrator</title>
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/horsey.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    <script src="/js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/configuration/app_orchestration/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
<div style="font-family: 'Raleway', serif; font-size: x-large">CHORIA</div>

    </div>
    
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
        
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/about/">
        <a href="/about/">
          <span>
            
              <b>1. </b>
            
             About Choria
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/deployment/">
        <a href="/deployment/">
          <span>
            
              <b>2. </b>
            
             Deployment
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/deployment/requirements/">
              <a href="/deployment/requirements/">
                <span>Requirements     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/nats/">
              <a href="/deployment/nats/">
                <span>NATS Middleware     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/dns/">
              <a href="/deployment/dns/">
                <span>DNS Setup     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/mcollective/">
              <a href="/deployment/mcollective/">
                <span>MCollective     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/first-user/">
              <a href="/deployment/first-user/">
                <span>First User     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/next-steps/">
              <a href="/deployment/next-steps/">
                <span>Next Steps     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/configuration/">
        <a href="/configuration/">
          <span>
            
              <b>3. </b>
            
             Optional Configuration
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/configuration/puppetdb/">
              <a href="/configuration/puppetdb/">
                <span>PuppetDB Discovery     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/aaa/">
              <a href="/configuration/aaa/">
                <span>MCollective AAA     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/plugins/">
              <a href="/configuration/plugins/">
                <span>Plugin Distribution     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/gems/">
              <a href="/configuration/gems/">
                <span>Gem Distribution     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item active" data-nav-id="/configuration/app_orchestration/">
              <a href="/configuration/app_orchestration/">
                <span>Application Orchestrator     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/reference/">
        <a href="/reference/">
          <span>
            
              <b>4. </b>
            
             Reference
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/reference/nats/">
              <a href="/reference/nats/">
                <span>NATS Connector     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/reference/security/">
              <a href="/reference/security/">
                <span>SSL Security     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/development/">
        <a href="/development/">
          <span>
            
              <b>5. </b>
            
             Development
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/development/rest/">
              <a href="/development/rest/">
                <span>REST Server Support     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/development/messages/">
              <a href="/development/messages/">
                <span>Message Structure     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
     
    <section id="footer">
      <p>Hosted at <a href="https://github.com/ripienaar/mcollective-choria">GitHub</a> by <a href="https://www.devco.net/">R.I. Pienaar</a></p>
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                
                
                  
                
                  
                    
                    
                <a href="/configuration/" itemprop="url"><span itemprop="title">Optional Configuration</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                  
                
                  
                
                  
                
                <span itemprop="title"> Application Orchestrator</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#example">Example</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#logic-flow">Logic Flow</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
    	        <div id="body-inner">
                
                <h1>Application Orchestrator</h1>
                



<p>Choria includes an Open Source Orchestrator compatible with the Puppet Site catalog system that allows you to describe a multi node deployment.</p>

<p>This orchestrator interprets the environment graphs Puppet produces and runs your nodes in the right order.</p>

<p>It uses the standard Puppet agent, best installed with ripienaar/mcollective_agent_puppet.</p>

<p>To use it requires some careful configuration, see the bottom of this page for details of that.</p>

<h2 id="example">Example</h2>

<p>The Puppet Site catalogs allow you describe a graph of multiple nodes, their dependencies, ordering and exchange information between them.</p>

<p>Here is a sample site with a Lamp stack:</p>

<pre><code class="language-puppet">site {
  lamp{'app2':
    db_user       =&gt; 'user',
    db_password   =&gt; 'secret',
    web_instances =&gt; 3,
    nodes         =&gt; {
      Node['dev1.example.net'] =&gt; Lamp::Mysql['app2'],
      Node['dev2.example.net'] =&gt; Lamp::Webapp['app2-1'],
      Node['dev3.example.net'] =&gt; Lamp::Webapp['app2-2'],
      Node['dev4.example.net'] =&gt; Lamp::Webapp['app2-3']
    }
  }

  lamp{'app1':
    db_user       =&gt; 'user',
    db_password   =&gt; 'secret',
    web_instances =&gt; 3,
    nodes         =&gt; {
      Node['dev1.example.net'] =&gt; Lamp::Mysql['app1'],
      Node['dev2.example.net'] =&gt; Lamp::Webapp['app1-1'],
      Node['dev3.example.net'] =&gt; Lamp::Webapp['app1-2'],
      Node['dev4.example.net'] =&gt; Lamp::Webapp['app1-3']
    }
  }
}
</code></pre>

<p>You can infer from this that there are node groups and that the <em>Lamp::Mysql</em> needs to be done prior to any <em>Lamp::Webapp</em>.  The orchastration part of this involves running Puppet in the desired order.</p>

<p>This tool will ask Puppet for the catalog, and after analysing it for cyclic dependencies, view or deploy it:</p>

<pre><code class="language-bash">$ mco choria run
Puppet Site Plan for the production Environment

2 applications on 4 managed nodes:

        Lamp[app1]
        Lamp[app2]

Node groups and run order:
   ------------------------------------------------------------------
        dev1.example.net
                Lamp[app1] -&gt; Lamp::Mysql[app1]
                Lamp[app2] -&gt; Lamp::Mysql[app2]

   ------------------------------------------------------------------
        dev2.example.net
                Lamp[app1] -&gt; Lamp::Webapp[app1-1]
                Lamp[app2] -&gt; Lamp::Webapp[app2-1]

        dev3.example.net
                Lamp[app1] -&gt; Lamp::Webapp[app1-2]
                Lamp[app2] -&gt; Lamp::Webapp[app2-2]

        dev4.example.net
                Lamp[app1] -&gt; Lamp::Webapp[app1-3]
                Lamp[app2] -&gt; Lamp::Webapp[app2-3]

Are you sure you wish to run this plan? (y/n) y

        2016-07-14 13:28:38 +0200: Checking if 4 nodes are enabled
        2016-07-14 13:28:38 +0200: Disabling Puppet on 4 nodes: Disabled during orchastration job initiated by rip.mcollective at 2016-07-14 13:28:38 +0200

Running node group 1 with 1 nodes batched 4 a time
        2016-07-14 13:28:38 +0200: Waiting for 1 nodes to become idle
        2016-07-14 13:28:38 +0200: Enabling Puppet on 1 nodes
        2016-07-14 13:28:38 +0200: Running Puppet on 1 nodes
        2016-07-14 13:28:38 +0200: Waiting for 1 nodes to start a run
        2016-07-14 13:28:43 +0200: Waiting for 1 nodes to become idle
        2016-07-14 13:29:03 +0200: Waiting for 1 nodes to become idle
        2016-07-14 13:29:24 +0200: Waiting for 1 nodes to become idle

Succesful run of 1 nodes in group 1 in 61.46 seconds

Running node group 2 with 3 nodes batched 4 a time
        2016-07-14 13:29:39 +0200: Waiting for 3 nodes to become idle
        2016-07-14 13:29:39 +0200: Enabling Puppet on 3 nodes
        2016-07-14 13:29:39 +0200: Running Puppet on 3 nodes
        2016-07-14 13:29:39 +0200: Waiting for 3 nodes to start a run
        2016-07-14 13:29:45 +0200: Waiting for 3 nodes to become idle
        2016-07-14 13:30:05 +0200: Waiting for 3 nodes to become idle
        2016-07-14 13:30:26 +0200: Waiting for 3 nodes to become idle

Succesful run of 3 nodes in group 2 in 61.78 seconds

        2016-07-14 13:30:41 +0200: Enabling Puppet on 4 nodes
</code></pre>

<h2 id="configuration">Configuration</h2>

<p>Setting up involves a few things, the instructions below work with the FOSS stack</p>

<ul>
<li>You should already have security certificates setup for Choria, run _mco choria request<em>cert</em> if not.</li>
<li>Your Puppet Server is found by looking in DNS or manual config as per the deployment guide, defaults to <em>puppet:8140</em>.</li>
</ul>

<p>On your PuppetServer use the _puppetlabs/puppet<em>authorization</em> module to add a authorization rule:</p>

<pre><code class="language-puppet">puppet_authorization::rule { &quot;puppetlabs environment&quot;:
  match_request_path   =&gt; &quot;/puppet/v3/environment&quot;,
  match_request_type   =&gt; &quot;path&quot;,
  match_request_method =&gt; &quot;get&quot;,
  allow                =&gt; [&quot;*.mcollective&quot;],
  sort_order           =&gt; 510,
  path                 =&gt; &quot;/etc/puppetlabs/puppetserver/conf.d/auth.conf&quot;,
  notify               =&gt; Class[&quot;puppetserver::config&quot;]
}
</code></pre>

<p>This gives certificates *.mcollective access to the environment graph, adjust to local taste.</p>

<p>Add in the old /etc/puppetlabs/puppet/auth.conf add an entry:</p>

<pre><code class="language-bash">path /puppet/v3/environment
method find
allow *
</code></pre>

<p>In your <em>/etc/puppetlabs/puppet/puppet.conf</em> add:</p>

<pre><code class="language-ini">[master]
app_management = true
</code></pre>

<p>Finally you need to have authorization to use the actions needed on the Puppet Agent, you can give yourself these by adding the following data to Hiera if you do not already have AAA rules, in this manner you can allow app runs to just certain environments, machines or whichever nodes you like:</p>

<pre><code class="language-yaml">mcollective_agent_puppet::policies:
  - action: &quot;allow&quot;
    callers: &quot;puppet=rip.mcollective&quot;
    actions: &quot;disable,enable,last_run_summary,runonce,status&quot;
    facts: &quot;*&quot;
    classes: &quot;*&quot;
</code></pre>

<h2 id="logic-flow">Logic Flow</h2>

<p>To give you an idea for what these deployments actually do, this is the logic flow they take:</p>

<p>Once it has the site catalog from the Puppet Server it finds the list of all nodes in the site and also groups of them and the order to run in.</p>

<ol>
<li>Checks if all the nodes are enabled, if any are disabled it cannot continue</li>
<li>Disables all the nodes so no automated or human triggered runs can interfere</li>
<li>Waits for all nodes to become idle, if after a long timeout they don&rsquo;t exit</li>
<li>Iterate the groups finding the nodes per group, loop them possibly in small batches

<ol>
<li>Enable Puppet on these nodes</li>
<li>Run Puppet</li>
<li>Wait for it to start, exit if they do not idle after a long time</li>
<li>Wait for it to become idle, exit if they do not go idle after a long time</li>
<li>Disable them all</li>
<li>If any of the nodes had failed resources, fail</li>
</ol></li>
<li>Enable all the nodes on success, Disable all the nodes on fail since the stack is now inconsistent</li>
</ol>

<p>There is some improvements to be made, specifically there&rsquo;s a small window between
running the nodes and disabling them again that another run can start, end of the
day though it works out, all the daemons are idle when the status is fetched and
this is definitely for a run started after the one we needed.  So the end out come
is the same</p>

<p>## Status</p>

<p>The basic feature work and it works with the Open Source PuppetServer too, but the feature in Puppet is extremely new and needs some improvement, this tool is going to be only as good as what Puppet provides.</p>


      
      </div>
    </div>

    <div id="navigation">
        
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky-kit.min.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>
    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-10152852-12', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


  </body>
</html>

