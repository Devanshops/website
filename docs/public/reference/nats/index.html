<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.17" />
    <meta name="description" content="Documentation for the Choria Orchestrator">
<meta name="author" content="R.I.Pienaar &lt;rip@devco.net&gt;">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    
    <title>NATS Connector</title>
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/horsey.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    <script src="/js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/reference/nats/">
    <nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
      <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
<div style="font-family: 'Raleway', serif; font-size: x-large">CHORIA</div>

    </div>
    
</div>


  <div class="highlightable">
    <ul class="topics">
      
      
        
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/about/">
        <a href="/about/">
          <span>
            
              <b>1. </b>
            
             About Choria
            
           </span>
        </a>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/deployment/">
        <a href="/deployment/">
          <span>
            
              <b>2. </b>
            
             Deployment
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/deployment/requirements/">
              <a href="/deployment/requirements/">
                <span>Requirements     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/nats/">
              <a href="/deployment/nats/">
                <span>NATS Middleware     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/dns/">
              <a href="/deployment/dns/">
                <span>DNS Setup     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/mcollective/">
              <a href="/deployment/mcollective/">
                <span>MCollective     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/first-user/">
              <a href="/deployment/first-user/">
                <span>First User     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/deployment/next-steps/">
              <a href="/deployment/next-steps/">
                <span>Next Steps     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/configuration/">
        <a href="/configuration/">
          <span>
            
              <b>3. </b>
            
             Optional Configuration
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/configuration/puppetdb/">
              <a href="/configuration/puppetdb/">
                <span>PuppetDB Discovery     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/aaa/">
              <a href="/configuration/aaa/">
                <span>MCollective AAA     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/plugins/">
              <a href="/configuration/plugins/">
                <span>Plugin Distribution     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/gems/">
              <a href="/configuration/gems/">
                <span>Gem Distribution     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/configuration/app_orchestration/">
              <a href="/configuration/app_orchestration/">
                <span>Application Orchestrator     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  parent" data-nav-id="/reference/">
        <a href="/reference/">
          <span>
            
              <b>4. </b>
            
             Reference
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item active" data-nav-id="/reference/nats/">
              <a href="/reference/nats/">
                <span>NATS Connector     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/reference/security/">
              <a href="/reference/security/">
                <span>SSL Security     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
      

      
        
      
      
      

      <li class="dd-item  " data-nav-id="/development/">
        <a href="/development/">
          <span>
            
              <b>5. </b>
            
             Development
            
           </span>
        </a>
        
        <ul>
          
          
          
          
            <li class="dd-item " data-nav-id="/development/rest/">
              <a href="/development/rest/">
                <span>REST Server Support     </i></span>
              </a>
            </li>
          
          
          
            <li class="dd-item " data-nav-id="/development/messages/">
              <a href="/development/messages/">
                <span>Message Structure     </i></span>
              </a>
            </li>
          
          
        </ul>
        
      </li>
      
      
    </ul>
    <hr>
     
    <section id="footer">
      <p>Hosted at <a href="https://github.com/ripienaar/mcollective-choria">GitHub</a> by <a href="https://www.devco.net/">R.I. Pienaar</a></p>
    </section>
  </div>
</nav>

        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">

            <div id="top-bar">
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                
                <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>
                
                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                <a href="/reference/" itemprop="url"><span itemprop="title">Reference</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                <span itemprop="title"> NATS Connector</span>
              </div>
              
                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#basic-setup">Basic Setup</a></li>
<li><a href="#server-tls-setup">Server TLS Setup</a></li>
<li><a href="#client-tls-setup">Client TLS Setup</a></li>
<li><a href="#example-nats-server-configuration">Example NATS Server configuration</a></li>
<li><a href="#plugin-configuration-reference">Plugin Configuration Reference</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

              

            </div>
            
    	        <div id="body-inner">
                
                <h1>NATS Connector</h1>
                



<p>A MCollective Connector plugin for the <a href="https://nats.io/">NATS</a> middleware broker designed to work within a configured Choria setup.</p>

<p>It&rsquo;s goals are to be secure by default while requiring almost no configuration, it only supports TLS and it only supports doing verified TLS connections to the broker. You cannot disable this.</p>

<p>This plugin uses the nats rubygem which unfortunately needs Event Machine. So you might need compilers on your nodes to install that.</p>

<h2 id="basic-setup">Basic Setup</h2>

<div class="notices tip" ><p>After installing MCollective Choria this plugin is already completely deployed. This page is for reference only.</p>
</div>


<p>In your mcollective config files you should enable this plugin:</p>

<pre><code class="language-ini">connector = nats
</code></pre>

<p>If you put your NATS server on your Puppet Master and it uses port <em>4222</em> on the hostname <em>puppet</em> then everything will just work.</p>

<p>If not you can add some DNS SRV records:</p>

<pre><code class="language-bash">_mcollective-server._tcp   IN  SRV 10  0 4222  nats1.example.net.
_mcollective-server._tcp   IN  SRV 11  0 4222  nats2.example.net.
</code></pre>

<p>If you use SRV records with Puppet it might be better for you to use the Puppet scheme so you can also do:</p>

<pre><code class="language-bash">_x-puppet-mcollective._tcp     IN  SRV 10  0 4222  nats1.example.net.
_x-puppet-mcollective._tcp     IN  SRV 11  0 4222  nats2.example.net.
</code></pre>

<p>At present weights are not considered.</p>

<p>You can hard code the server list, see the Configuration Refernece section below.</p>

<h2 id="server-tls-setup">Server TLS Setup</h2>

<p>When running as root it assumes it&rsquo;s a server and so SSL settings are as per a Puppet Agent.</p>

<h2 id="client-tls-setup">Client TLS Setup</h2>

<p>When not running as root it will try to use SSL from your home directory and again some assumptions about you running Puppet 4.</p>

<p>Here the certname is based on your username so <em>uname.mcollective.pem</em>, you need to create these certs via your Puppet CA:</p>

<pre><code class="language-bash">$ mco choria request_cert
</code></pre>

<h2 id="example-nats-server-configuration">Example NATS Server configuration</h2>

<p>NATS is pretty easy to deploy, this plugin will only communicate over TLS so you need to configure things correctly.  The <em>ripienaar-nats</em> module does this for you, but here&rsquo;s a example NATS config of a 3 node cluster set up with TLS should you wish to do your own:</p>

<pre><code>port: 4222
monitor_port: 8222

debug: false
trace: false

tls {
  cert_file: &quot;/etc/puppetlabs/puppet/ssl/certs/dev1.example.net.pem&quot;
  key_file: &quot;/etc/puppetlabs/puppet/ssl/private_keys/dev1.example.net.pem&quot;
  ca_file: &quot;/etc/puppetlabs/puppet/ssl/certs/ca.pem&quot;
  verify: true
  timeout: 2
}

cluster {
  port: 4223
  no_advertise: true

  tls {
    cert_file: &quot;/etc/puppetlabs/puppet/ssl/certs/dev1.example.net.pem&quot;
    key_file: &quot;/etc/puppetlabs/puppet/ssl/private_keys/dev1.example.net.pem&quot;
    ca_file: &quot;/etc/puppetlabs/puppet/ssl/certs/ca.pem&quot;
    verify: true
    timeout: 2
  }

  authorization {
    user: routes
    password: eighieGhohqu
    timeout: 0.75
  }

  routes = [
    nats-route://routes:s3cret@dev2.example.net:4223
    nats-route://routes:s3cret@puppet1.example.net:4223
  ]
}

max_payload: 1048576
max_pending_size: 10485760
max_connections: 65536
</code></pre>

<p>You can also get this going quickly using Docker for development:</p>

<pre><code class="language-bash">$ docker run -d -p 4222:4222 -p 4223:4223 \
  -v /path/to/your/gnatsd.conf:/config/gnatsd.conf \
    -v /etc/puppetlabs/puppet/ssl:/etc/puppetlabs/puppet/ssl \
      --name nats nats --config /config/gnatsd.conf -DV
</code></pre>

<h2 id="plugin-configuration-reference">Plugin Configuration Reference</h2>

<p>You should only need to change configuration if you do not accept the defaults, this plugin is intended to
just work, so if you have a standard setup that does not just work please let me know so we can see if it
can be catered for.</p>

<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>

<tbody>
<tr>
<td>choria.srv_domain</td>
<td>Override the domain used for SRV lookups</td>
<td>default to <em>facter networking.domain</em></td>
</tr>

<tr>
<td>choria.middleware_hosts</td>
<td>Comma seperated list of servers like <em>nats1:4222,nats2:4222</em></td>
<td>Uses SRV records or <em>puppet:4222</em></td>
</tr>

<tr>
<td>nats.user</td>
<td>Username when connecting to nats</td>
<td>not used</td>
</tr>

<tr>
<td>nats.pass</td>
<td>Password when connecting to nats</td>
<td>not used</td>
</tr>
</tbody>
</table>

<p>You can set <em>MCOLLECTIVE_NATS_USERNAME</em> and <em>MCOLLECTIVE_NATS_PASSWORD</em> to configure the <em>nats.user</em> and <em>nats.pass</em>.</p>


      
      </div>
    </div>

    <div id="navigation">
        
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky-kit.min.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>
    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-10152852-12', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


  </body>
</html>

